{% extends "base.html" %}
{% load static %}

{% block title %}Home - Sangabiz{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="container">
        <h1>Discover Your Sound</h1>
        <p>Stream millions of songs, create playlists, and share your favorite tracks with the world.</p>
        <div class="cta-buttons">
            {% if user.is_authenticated %}
            <button class="primary-btn" onclick="startListening()">Start Listening</button>
            {% else %}
            <button class="primary-btn" onclick="showSignupModal()">Get Started Free</button>
            <button class="secondary-btn" onclick="showLoginModal()">Login</button>
            {% endif %}
        </div>
    </div>
</section>

<!-- Stats Overview -->
{% if user.is_authenticated and user.is_staff %}
<section class="container" style="margin-bottom: 40px;">
    <div class="stats-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="background: var(--card-bg); padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 32px; color: var(--primary); margin-bottom: 10px;">
                <i class="fas fa-music"></i>
            </div>
            <h3 style="color: var(--light); margin-bottom: 5px;">{{ total_songs }}</h3>
            <p style="color: var(--gray); margin: 0;">Total Songs</p>
        </div>
        <div style="background: var(--card-bg); padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 32px; color: var(--secondary); margin-bottom: 10px;">
                <i class="fas fa-play"></i>
            </div>
            <h3 style="color: var(--light); margin-bottom: 5px;">{{ total_plays }}</h3>
            <p style="color: var(--gray); margin: 0;">Total Plays</p>
        </div>
        <div style="background: var(--card-bg); padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 32px; color: var(--primary); margin-bottom: 10px;">
                <i class="fas fa-download"></i>
            </div>
            <h3 style="color: var(--light); margin-bottom: 5px;">{{ total_downloads }}</h3>
            <p style="color: var(--gray); margin: 0;">Total Downloads</p>
        </div>
    </div>
</section>
{% endif %}

<!-- Featured Songs - Mdundo Style -->
<section class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 class="section-title">
            <i class="fas fa-fire"></i>
            Featured Songs
        </h2>
        <a href="{% url 'discover' %}" style="color: var(--primary); text-decoration: none; font-weight: 600;">
            View All <i class="fas fa-arrow-right"></i>
        </a>
    </div>
    
    <!-- Mdundo Style Song List -->
    <div class="mdundo-song-list">
        {% for song in featured_songs %}
        <div class="mdundo-song-item" data-song-id="{{ song.id }}">
            <div class="song-number">{{ forloop.counter }}</div>
            <div class="song-image" style="background-image: url('{% if song.cover_image %}{{ song.cover_image.url }}{% else %}{% static 'images/default-cover.jpg' %}{% endif %}')"></div>
            <div class="song-info">
                <h4 class="song-title">{{ song.title }}</h4>
                <p class="song-artist">{{ song.artist.name }}</p>
                <div class="song-meta">
                    <span class="song-genre">{{ song.genre.name }}</span>
                    <span class="song-duration">{{ song.duration|time:"i:s" }}</span>
                </div>
            </div>
            <div class="song-stats-mobile">
                <div class="stat">
                    <i class="fas fa-play"></i>
                    <span>{{ song.plays }}</span>
                </div>
                <div class="stat">
                    <i class="fas fa-download"></i>
                    <span>{{ song.downloads }}</span>
                </div>
            </div>
            <div class="song-actions">
                <button class="mdundo-play-btn" onclick="playSongFromCard({{ song.id }})" title="Play">
                    <i class="fas fa-play"></i>
                </button>
                <button class="mdundo-download-btn" onclick="downloadSong({{ song.id }}, this)" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                {% if user.is_authenticated %}
                <button class="mdundo-like-btn" onclick="likeSong({{ song.id }}, this)" title="Like">
                    <i class="far fa-heart"></i>
                </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="no-songs">
            <i class="fas fa-music"></i>
            <p>No featured songs available yet.</p>
            {% if user.is_authenticated and user.is_staff %}
            <a href="/admin/music/song/add/" class="primary-btn">
                <i class="fas fa-plus"></i> Add Songs
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</section>

<!-- Top Charts - Mdundo Style -->
<section class="container" style="margin-top: 60px;">
    <h2 class="section-title">
        <i class="fas fa-chart-line"></i>
        Top Charts
    </h2>
    
    <div class="charts-grid">
        <!-- Most Played -->
        <div class="chart-section">
            <h3 class="chart-title">
                <i class="fas fa-play" style="color: var(--primary);"></i>
                Most Played
            </h3>
            <div class="mdundo-song-list compact">
                {% for song in most_played %}
                <div class="mdundo-song-item compact" onclick="playSongFromCard({{ song.id }})" data-chart-song-id="{{ song.id }}">
                    <div class="song-number">{{ forloop.counter }}</div>
                    <div class="song-info">
                        <h4 class="song-title">{{ song.title }}</h4>
                        <p class="song-artist">{{ song.artist.name }}</p>
                    </div>
                    <div class="song-plays">
                        <i class="fas fa-play"></i>
                        <span>{{ song.plays }}</span>
                    </div>
                </div>
                {% empty %}
                <div class="no-data">
                    <i class="fas fa-music"></i>
                    <p>No plays yet</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Most Downloaded -->
        <div class="chart-section">
            <h3 class="chart-title">
                <i class="fas fa-download" style="color: var(--secondary);"></i>
                Most Downloaded
            </h3>
            <div class="mdundo-song-list compact">
                {% for song in most_downloaded %}
                <div class="mdundo-song-item compact" onclick="playSongFromCard({{ song.id }})" data-chart-song-id="{{ song.id }}">
                    <div class="song-number">{{ forloop.counter }}</div>
                    <div class="song-info">
                        <h4 class="song-title">{{ song.title }}</h4>
                        <p class="song-artist">{{ song.artist.name }}</p>
                    </div>
                    <div class="song-downloads">
                        <i class="fas fa-download"></i>
                        <span>{{ song.downloads }}</span>
                    </div>
                </div>
                {% empty %}
                <div class="no-data">
                    <i class="fas fa-music"></i>
                    <p>No downloads yet</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<!-- Genres Section -->
<section class="container genres-section" style="margin-top: 60px;">
    <h2 class="section-title">
        <i class="fas fa-compass"></i>
        Browse Genres
    </h2>
    <div class="genres-grid">
        {% for genre in genres %}
        <a href="{% url 'genre_songs' genre.id %}" class="genre-link">
            <div class="genre-card" style="background: {{ genre.color|default:'linear-gradient(135deg, #6c5ce7, #fd79a8)' }};">
                <span class="genre-name">{{ genre.name }}</span>
                <div class="genre-count">{{ genre.song_count }} songs</div>
            </div>
        </a>
        {% endfor %}
    </div>
</section>

<!-- Recent Activity -->
{% if user.is_authenticated %}
<section class="container" style="margin-top: 60px;">
    <h2 class="section-title">
        <i class="fas fa-history"></i>
        Your Recent Activity
    </h2>
    <div class="mdundo-song-list compact">
        {% for play in recent_plays %}
        <div class="mdundo-song-item compact" data-song-id="{{ play.song.id }}">
            <div class="song-image small" style="background-image: url('{% if play.song.cover_image %}{{ play.song.cover_image.url }}{% else %}{% static 'images/default-cover.jpg' %}{% endif %}')"></div>
            <div class="song-info">
                <h4 class="song-title">{{ play.song.title }}</h4>
                <p class="song-artist">{{ play.song.artist.name }}</p>
                <span class="activity-time">{{ play.played_at|timesince }} ago</span>
            </div>
            <button class="mdundo-play-btn small" onclick="playSongFromCard({{ play.song.id }})">
                <i class="fas fa-play"></i>
            </button>
        </div>
        {% empty %}
        <div class="no-data">
            <i class="fas fa-history"></i>
            <p>No recent activity</p>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
/* ===== HERO SECTION WITH SPLASH BACKGROUND ===== */
.hero {
    background: linear-gradient(135deg, 
                rgba(108, 92, 231, 0.85), 
                rgba(253, 121, 168, 0.85)),
                url('{% static "images/hero-bg.jpg" %}') center/cover no-repeat;
    padding: 120px 0;
    text-align: center;
    color: white;
    position: relative;
    overflow: hidden;
}

.hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('{% static "images/hero-bg.jpg" %}') repeat;
    opacity: 0.1;
    animation: float 20s infinite linear;
}

@keyframes float {
    0% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
    100% { transform: translateY(0px) rotate(360deg); }
}

.hero .container {
    position: relative;
    z-index: 2;
}

.hero h1 {
    font-size: 3.5rem;
    margin-bottom: 20px;
    font-weight: 800;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
    background: linear-gradient(45deg, #fff, #e0e0e0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero p {
    font-size: 1.3rem;
    margin-bottom: 40px;
    opacity: 0.95;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
    font-weight: 300;
    line-height: 1.6;
}

.cta-buttons {
    display: flex;
    gap: 20px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
}

.primary-btn, .secondary-btn {
    padding: 15px 35px;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.primary-btn {
    background: linear-gradient(135deg, var(--primary), #5f27cd);
    color: white;
}

.primary-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(108, 92, 231, 0.4);
}

.secondary-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.secondary-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(255, 255, 255, 0.2);
}

/* Fallback if splash images don't load */
.hero {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
}

/* ===== DESKTOP STYLES (768px and above) - Original Full Layout ===== */
.mdundo-song-list {
    background: var(--card-bg);
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    overflow: hidden;
}

.mdundo-song-list.compact {
    background: transparent;
    border: none;
}

.mdundo-song-item {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    transition: var(--transition);
    cursor: pointer;
}

.mdundo-song-item:last-child {
    border-bottom: none;
}

.mdundo-song-item:hover {
    background: rgba(255,255,255,0.05);
}

.mdundo-song-item.compact {
    padding: 12px 15px;
    background: var(--card-bg);
    border-radius: 10px;
    margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.1);
}

.mdundo-song-item.compact:last-child {
    margin-bottom: 0;
}

.song-number {
    font-weight: bold;
    color: var(--primary);
    min-width: 30px;
    font-size: 16px;
    text-align: center;
}

.song-image {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    margin: 0 15px;
    flex-shrink: 0;
}

.song-image.small {
    width: 40px;
    height: 40px;
    margin: 0 12px 0 0;
}

.song-info {
    flex: 1;
    min-width: 0;
}

.song-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 4px 0;
    color: var(--light);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.song-artist {
    font-size: 14px;
    color: var(--gray);
    margin: 0 0 4px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.song-meta {
    display: flex;
    gap: 15px;
    font-size: 12px;
    color: var(--gray-light);
}

.song-duration {
    color: var(--primary);
}

.song-stats-mobile {
    display: flex;
    gap: 15px;
    margin: 0 20px;
}

.song-stats-mobile .stat {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: var(--gray);
}

.song-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* Mdundo Style Buttons */
.mdundo-play-btn {
    background: linear-gradient(135deg, var(--primary), #5f27cd);
    color: white;
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 16px;
    box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
}

.mdundo-play-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
}

.mdundo-play-btn.small {
    width: 36px;
    height: 36px;
    font-size: 14px;
}

.mdundo-download-btn {
    background: linear-gradient(135deg, var(--secondary), #e84393);
    color: white;
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 16px;
    box-shadow: 0 4px 15px rgba(253, 121, 168, 0.3);
}

.mdundo-download-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(253, 121, 168, 0.4);
}

.mdundo-like-btn {
    background: rgba(255,255,255,0.1);
    color: var(--gray);
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 16px;
}

.mdundo-like-btn:hover {
    color: var(--secondary);
    background: rgba(253, 121, 168, 0.1);
}

/* Charts Layout */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
}

.chart-section {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(255,255,255,0.1);
}

.chart-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    font-size: 18px;
    color: var(--light);
}

.song-plays, .song-downloads {
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--gray);
    font-size: 14px;
    margin-left: auto;
    padding-left: 15px;
}

/* No Content States */
.no-songs, .no-data {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
}

.no-songs i, .no-data i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Genres */
.genre-link {
    text-decoration: none;
}

.genre-card {
    position: relative;
    padding: 25px 20px;
    border-radius: 12px;
    color: white;
    text-align: center;
    transition: var(--transition);
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.genre-card:hover {
    transform: translateY(-5px);
}

.genre-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 5px;
}

.genre-count {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
}

/* Button States */
.mdundo-download-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.mdundo-download-btn.downloading {
    animation: spin 1s linear infinite;
    background: linear-gradient(135deg, var(--primary), #5f27cd);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Activity Time */
.activity-time {
    font-size: 12px;
    color: var(--gray);
}

/* ===== MOBILE STYLES (768px and below) - Compact Single Line ===== */
@media (max-width: 768px) {
    /* Hero section mobile adjustments */
    .hero {
        padding: 80px 0;
        background: linear-gradient(135deg, 
                    rgba(108, 92, 231, 0.9), 
                    rgba(253, 121, 168, 0.9)),
                    url('{% static "images/splash-bg-mobile.jpg" %}') center/cover no-repeat;
    }
    
    .hero h1 {
        font-size: 2.5rem;
    }
    
    .hero p {
        font-size: 1.1rem;
    }
    
    .cta-buttons {
        flex-direction: column;
        gap: 15px;
    }
    
    .primary-btn, .secondary-btn {
        width: 100%;
        max-width: 280px;
        padding: 12px 30px;
    }
    
    .mdundo-song-item {
        padding: 10px 12px;
        min-height: 50px;
        align-items: center;
        gap: 12px;
        position: relative;
    }
    
    .mdundo-song-item.compact {
        padding: 8px 10px;
        min-height: 45px;
        gap: 10px;
    }
    
    .song-number {
        min-width: 25px;
        font-size: 14px;
    }
    
    .song-image {
        width: 45px;
        height: 45px;
        margin: 0;
        flex-shrink: 0;
    }
    
    .song-image.small {
        width: 40px;
        height: 40px;
        margin: 0;
    }
    
    /* Extended song info area near image */
    .song-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-right: 0;
        padding-right: 10px;
    }
    
    .song-title {
        font-size: 15px;
        margin: 0;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .song-artist {
        font-size: 13px;
        margin: 0;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Hide genre and meta on mobile only */
    .song-meta {
        display: none;
    }
    
    /* Stats below buttons for mobile */
    .song-stats-mobile {
        display: none; /* Hide the inline stats */
    }
    
    .song-actions {
        gap: 6px;
        flex-shrink: 0;
        position: relative;
    }
    
    /* Stats below buttons container */
    .song-actions-stats {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }
    
    .song-stats-below {
        display: flex;
        gap: 12px;
        font-size: 10px;
        color: var(--gray);
        opacity: 0.8;
    }
    
    .song-stats-below .stat {
        display: flex;
        align-items: center;
        gap: 3px;
        white-space: nowrap;
    }
    
    .song-stats-below i {
        font-size: 9px;
    }
    
    .mdundo-play-btn,
    .mdundo-download-btn,
    .mdundo-like-btn {
        width: 38px;
        height: 38px;
        font-size: 14px;
        flex-shrink: 0;
    }
    
    .mdundo-play-btn.small {
        width: 34px;
        height: 34px;
        font-size: 13px;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .chart-section {
        padding: 15px;
    }
    
    /* Charts - Show images and extend text area */
    .mdundo-song-item.compact {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .mdundo-song-item.compact .song-image {
        display: block;
        width: 40px;
        height: 40px;
        margin: 0;
        flex-shrink: 0;
    }
    
    .mdundo-song-item.compact .song-info {
        flex: 1;
        min-width: 0;
        margin-right: 0;
        padding-right: 8px;
    }
    
    .mdundo-song-item.compact .song-title {
        font-size: 14px;
    }
    
    .mdundo-song-item.compact .song-artist {
        font-size: 12px;
    }
    
    .song-plays, .song-downloads {
        font-size: 12px;
        padding-left: 8px;
        margin-left: 0;
        flex-shrink: 0;
    }
    
    /* Recent Activity - Show images and extend text area */
    .mdundo-song-list.compact .mdundo-song-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .mdundo-song-list.compact .song-image {
        display: block;
        width: 40px;
        height: 40px;
        margin: 0;
        flex-shrink: 0;
    }
    
    .mdundo-song-list.compact .song-info {
        flex: 1;
        min-width: 0;
        margin-right: 0;
        padding-right: 8px;
    }
    
    .mdundo-song-list.compact .song-title {
        font-size: 14px;
    }
    
    .mdundo-song-list.compact .song-artist {
        font-size: 12px;
    }
    
    .mdundo-song-list.compact .activity-time {
        font-size: 11px;
        margin-top: 2px;
    }
    
    /* Ensure everything stays in one horizontal line on mobile */
    .mdundo-song-item {
        flex-wrap: nowrap;
        overflow: hidden;
    }
    
    .song-info {
        overflow: hidden;
    }
    
    .song-actions-stats {
        flex-shrink: 0;
    }
}

/* Very small phones */
@media (max-width: 480px) {
    .hero {
        padding: 60px 0;
    }
    
    .hero h1 {
        font-size: 2rem;
    }
    
    .hero p {
        font-size: 1rem;
    }
    
    .mdundo-song-item {
        padding: 8px 10px;
        min-height: 45px;
        gap: 10px;
    }
    
    .mdundo-song-item.compact {
        padding: 6px 8px;
        min-height: 40px;
        gap: 8px;
    }
    
    .song-number {
        min-width: 22px;
        font-size: 13px;
    }
    
    .song-image {
        width: 40px;
        height: 40px;
    }
    
    .song-image.small {
        width: 36px;
        height: 36px;
    }
    
    .song-title {
        font-size: 14px;
    }
    
    .song-artist {
        font-size: 12px;
    }
    
    .mdundo-play-btn,
    .mdundo-download-btn,
    .mdundo-like-btn {
        width: 34px;
        height: 34px;
        font-size: 13px;
    }
    
    .mdundo-play-btn.small {
        width: 30px;
        height: 30px;
        font-size: 12px;
    }
    
    .song-actions {
        gap: 4px;
    }
    
    .song-stats-below {
        gap: 10px;
        font-size: 9px;
    }
    
    .song-stats-below i {
        font-size: 8px;
    }
    
    .song-plays, .song-downloads {
        font-size: 11px;
        padding-left: 6px;
    }
    
    /* Adjust chart and activity images for very small screens */
    .mdundo-song-item.compact .song-image,
    .mdundo-song-list.compact .song-image {
        width: 36px;
        height: 36px;
    }
    
    .mdundo-song-item.compact .song-title,
    .mdundo-song-list.compact .song-title {
        font-size: 13px;
    }
    
    .mdundo-song-item.compact .song-artist,
    .mdundo-song-list.compact .song-artist {
        font-size: 11px;
    }
}

/* Extra small screens - optimize layout */
@media (max-width: 360px) {
    .song-info {
        min-width: 100px;
    }
    
    /* Make song info and image closer */
    .mdundo-song-item {
        gap: 8px;
    }
    
    .mdundo-song-item.compact {
        gap: 6px;
    }
    
    /* Reduce font sizes further for very small screens */
    .song-title {
        font-size: 13px;
    }
    
    .song-artist {
        font-size: 11px;
    }
    
    /* Make buttons even smaller */
    .mdundo-play-btn,
    .mdundo-download-btn,
    .mdundo-like-btn {
        width: 32px;
        height: 32px;
        font-size: 12px;
    }
    
    .mdundo-play-btn.small {
        width: 28px;
        height: 28px;
        font-size: 11px;
    }
    
    .song-stats-below {
        gap: 8px;
        font-size: 8px;
    }
}

/* Ensure images are visible in charts and recent activity on mobile */
@media (max-width: 768px) {
    /* Show images in top charts */
    .mdundo-song-item.compact .song-image {
        display: block !important;
    }
    
    /* Show images in recent activity */
    .mdundo-song-list.compact .song-image {
        display: block !important;
    }
    
    /* Extended text area near images */
    .song-info {
        flex: 1;
        min-width: 0;
        padding-right: 10px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize playlist with featured songs
const featuredSongs = [
    {% for song in featured_songs %}
    {
        id: {{ song.id }},
        title: "{{ song.title|escapejs }}",
        artist: "{{ song.artist.name|escapejs }}",
        cover: "{% if song.cover_image %}{{ song.cover_image.url }}{% else %}{% static 'images/default-cover.jpg' %}{% endif %}",
        audio: "{{ song.audio_file.url }}",
        duration: {{ song.duration }},
        plays: {{ song.plays }},
        downloads: {{ song.downloads }}
    },
    {% endfor %}
];

// Initialize charts songs
const chartsSongs = [
    {% for song in most_played %}
    {
        id: {{ song.id }},
        title: "{{ song.title|escapejs }}",
        artist: "{{ song.artist.name|escapejs }}",
        cover: "{% if song.cover_image %}{{ song.cover_image.url }}{% else %}{% static 'images/default-cover.jpg' %}{% endif %}",
        audio: "{{ song.audio_file.url }}",
        duration: {{ song.duration }},
        plays: {{ song.plays }},
        downloads: {{ song.downloads }}
    },
    {% endfor %}
];

// Combine all songs for the player
const allSongs = [...featuredSongs, ...chartsSongs];
initializePlaylist(allSongs);

function startListening() {
    if (featuredSongs.length > 0) {
        playSong(featuredSongs[0]);
    } else if (chartsSongs.length > 0) {
        playSong(chartsSongs[0]);
    }
}

function playSongFromCard(songId) {
    const song = allSongs.find(s => s.id === songId);
    if (song) {
        playSong(song);
    } else {
        // If song not in current playlist, fetch it
        fetch(`/play-song/${songId}/`)
            .then(response => response.json())
            .then(songData => {
                playSong(songData);
            })
            .catch(error => {
                console.error('Error playing song:', error);
            });
    }
}

function likeSong(songId, button) {
    {% if user.is_authenticated %}
    fetch(`/like-song/${songId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        const icon = button.querySelector('i');
        if (data.liked) {
            icon.classList.remove('far');
            icon.classList.add('fas');
            button.style.color = 'var(--secondary)';
            showNotification('Added to liked songs!', 'success', 2000);
        } else {
            icon.classList.remove('fas');
            icon.classList.add('far');
            button.style.color = 'var(--gray)';
            showNotification('Removed from liked songs', 'info', 2000);
        }
    })
    .catch(error => {
        console.error('Error liking song:', error);
        showNotification('Error liking song', 'error', 3000);
    });
    {% else %}
    showModal(loginModal);
    {% endif %}
}

function downloadSong(songId, button = null) {
    {% if user.is_authenticated %}
    if (button) {
        button.disabled = true;
        button.classList.add('downloading');
        button.innerHTML = '<i class="fas fa-spinner"></i>';
    }
    
    fetch(`/download-song/${songId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Download failed');
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Get song name for filename
        const song = allSongs.find(s => s.id === songId) || 
                    (currentSong && currentSong.id === songId ? currentSong : null);
        const filename = song ? `${song.title} - ${song.artist}.mp3` : `song-${songId}.mp3`;
        a.download = filename.replace(/[^a-zA-Z0-9\s\-\.]/g, '');
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Update download count in UI
        fetch(`/get-song-stats/${songId}/`)
            .then(response => response.json())
            .then(data => {
                updateSongStats(songId, 'downloads', data.downloads);
            })
            .catch(error => {
                console.error('Error fetching updated stats:', error);
            });
        
        showNotification('Song downloaded successfully!', 'success');
    })
    .catch(error => {
        console.error('Download error:', error);
        showNotification('Download failed. Please try again.', 'error');
    })
    .finally(() => {
        if (button) {
            button.disabled = false;
            button.classList.remove('downloading');
            button.innerHTML = '<i class="fas fa-download"></i>';
        }
    });
    {% else %}
    showModal(loginModal);
    {% endif %}
}

// Update song statistics in the UI
function updateSongStats(songId, statType, newValue) {
    // Update stats in Mdundo style list
    const songItems = document.querySelectorAll(`[data-song-id="${songId}"]`);
    songItems.forEach(item => {
        const statElements = item.querySelectorAll(`.${statType}`);
        statElements.forEach(element => {
            element.textContent = newValue;
        });
    });
    
    // Update chart items
    const chartItems = document.querySelectorAll(`[data-chart-song-id="${songId}"] .${statType}`);
    chartItems.forEach(item => {
        item.textContent = newValue;
    });
}

function showSignupModal() {
    showModal(signupModal);
}

function showLoginModal() {
    showModal(loginModal);
}
</script>
{% endblock %}