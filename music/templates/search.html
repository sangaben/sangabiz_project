{% extends "base.html" %}
{% load static %}

{% block title %}Search - Sangabiz{% endblock %}

{% block content %}
<section class="container">
    <h2 class="section-title">
        <i class="fas fa-search"></i>
        Search Results for "{{ query }}"
    </h2>
    
    {% if songs %}
    <div class="featured-grid">
        {% for song in songs %}
        <div class="song-card">
            <div class="card-image" style="background-image: url('{% if song.cover_image %}{{ song.cover_image.url }}{% else %}{% static 'images/default-cover.jpg' %}{% endif %}')"></div>
            <div class="card-content">
                <h3>{{ song.title }}</h3>
                <p>{{ song.artist.name }} â€¢ {{ song.genre.name }}</p>
                <div class="card-actions">
                    <button class="play-btn" onclick="playSongFromCard({{ song.id }})">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="action-btn" onclick="likeSong({{ song.id }}, this)">
                        <i class="far fa-heart"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No songs found for "{{ query }}".</p>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
const searchSongs = [
    {% for song in songs %}
    {
        id: {{ song.id }},
        title: "{{ song.title }}",
        artist: "{{ song.artist.name }}",
        cover: "{% if song.cover_image %}{{ song.cover_image.url }}{% else %}{% static 'images/default-cover.jpg' %}{% endif %}",
        audio: "{{ song.audio_file.url }}",
        duration: {{ song.duration }}
    },
    {% endfor %}
];

initializePlaylist(searchSongs);

function playSongFromCard(songId) {
    const song = searchSongs.find(s => s.id === songId);
    if (song) {
        playSong(song);
    }
}

function likeSong(songId, button) {
    {% if user.is_authenticated %}
    fetch(`/like-song/${songId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        const icon = button.querySelector('i');
        if (data.liked) {
            icon.classList.remove('far');
            icon.classList.add('fas');
            button.style.color = 'var(--secondary)';
        } else {
            icon.classList.remove('fas');
            icon.classList.add('far');
            button.style.color = 'var(--gray)';
        }
    })
    .catch(error => {
        console.error('Error liking song:', error);
    });
    {% else %}
    showModal(loginModal);
    {% endif %}
}
</script>
{% endblock %}